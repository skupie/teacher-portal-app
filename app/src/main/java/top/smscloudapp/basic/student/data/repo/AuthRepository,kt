package top.smscloud.basic.student.data.repo

import android.os.Build
import com.google.firebase.messaging.FirebaseMessaging
import kotlinx.coroutines.tasks.await
import top.smscloud.basic.student.BuildConfig
import top.smscloud.basic.student.data.remote.SmsApi
import top.smscloud.basic.student.data.remote.dto.LoginRequest
import top.smscloud.basic.student.data.remote.dto.LoginResponse
import top.smscloud.basic.student.data.remote.dto.RegisterDeviceRequest
import top.smscloud.basic.student.data.remote.dto.UnregisterDeviceRequest
import top.smscloud.basic.student.data.session.SessionManager

class AuthRepository(
    private val api: SmsApi,
    private val sessionManager: SessionManager
) {

    suspend fun login(login: String, password: String, role: String): Result<LoginResponse> {
        return runCatching {
            val fcmToken = runCatching { FirebaseMessaging.getInstance().token.await() }.getOrNull()

            val response = api.login(
                LoginRequest(
                    login = login,
                    password = password,
                    role = role,
                    deviceName = Build.MODEL ?: "Android",
                    deviceToken = fcmToken,
                    appVersion = BuildConfig.VERSION_NAME
                )
            )

            sessionManager.saveAuthToken(response.token)
            if (!fcmToken.isNullOrBlank()) {
                sessionManager.saveFcmToken(fcmToken)
            }

            response
        }
    }

    suspend fun registerDeviceToken(token: String): Result<Unit> {
        return runCatching {
            val authToken = sessionManager.getAuthToken()
                ?: throw IllegalStateException("No auth token found")

            api.registerDevice(
                bearer = "Bearer $authToken",
                body = RegisterDeviceRequest(
                    deviceToken = token,
                    deviceName = Build.MODEL ?: "Android",
                    appVersion = BuildConfig.VERSION_NAME
                )
            )

            sessionManager.saveFcmToken(token)
        }
    }

    suspend fun logout(): Result<Unit> {
        return runCatching {
            val authToken = sessionManager.getAuthToken()
            val fcmToken = sessionManager.getFcmToken()

            if (!authToken.isNullOrBlank()) {
                if (!fcmToken.isNullOrBlank()) {
                    runCatching {
                        api.unregisterDevice(
                            bearer = "Bearer $authToken",
                            body = UnregisterDeviceRequest(deviceToken = fcmToken)
                        )
                    }
                }

                runCatching {
                    api.logout("Bearer $authToken")
                }
            }

            sessionManager.clearAll()
        }
    }
}
